var Keepass;!function(e){var t=function(){function t(){this.AES_CIPHER_UUID=new Uint8Array([49,193,242,230,191,113,67,80,190,88,5,33,106,252,90,255])}return t.prototype.readHeader=function(t){var r=new DataView(t,0,8),n={sigKeePass:r.getUint32(0,e.Util.littleEndian),sigKeePassType:r.getUint32(4,e.Util.littleEndian)},a=2594363651,i=3041655655,s=3041655654,o=3041655637,d=3041655653;if(n.sigKeePass!=a||n.sigKeePassType!=i&&n.sigKeePassType!=s&&n.sigKeePassType!=o&&n.sigKeePassType!=d)throw console.log("Signature fail.  sig 1:"+n.sigKeePass.toString(16)+", sig2:"+n.sigKeePassType.toString(16)),new Error("This is not a valid KeePass file - file signature is not correct.");return n.sigKeePassType==i||n.sigKeePassType==s?this.readKdbxHeader(t,8,n):this.readKdbHeader(t,8,n),n},t.prototype.readKdbHeader=function(t,r,n){var a=2,i=new DataView(t,r,116),s=i.getUint32(0,e.Util.littleEndian);if((s&a)!=a)throw new Error("We only support AES (aka Rijndael) encryption on KeePass KDB files.  This file is using something else.");try{n.cipher=this.AES_CIPHER_UUID,n.majorVersion=i.getUint16(4,e.Util.littleEndian),n.minorVersion=i.getUint16(6,e.Util.littleEndian),n.masterSeed=new Uint8Array(t,r+8,16),n.iv=new Uint8Array(t,r+24,16),n.numberOfGroups=i.getUint32(40,e.Util.littleEndian),n.numberOfEntries=i.getUint32(44,e.Util.littleEndian),n.contentsHash=new Uint8Array(t,r+48,32),n.transformSeed=new Uint8Array(t,r+80,32),n.keyRounds=i.getUint32(112,e.Util.littleEndian),n.keyRounds2=0,n.compressionFlags=0,n.protectedStreamKey=window.crypto.getRandomValues(new Uint8Array(16)),n.innerRandomStreamId=0,n.streamStartBytes=null,n.kdb=!0,n.dataStart=r+116}catch(o){throw new Error("Failed to parse KDB file header - file is corrupt or format not supported")}},t.prototype.readKdbxHeader=function(t,r,n){try{var a=new DataView(t,r,4);n.majorVersion=a.getUint16(0,e.Util.littleEndian),n.minorVersion=a.getUint16(2,e.Util.littleEndian),r+=4;for(var i=!1;!i;){var s=new DataView(t,r,3),o=s.getUint8(0),d=s.getUint16(1,e.Util.littleEndian),l=new DataView(t,r+3,d);switch(r+=3,o){case 0:i=!0;break;case 2:n.cipher=new Uint8Array(t,r,d);break;case 3:n.compressionFlags=l.getUint32(0,e.Util.littleEndian);break;case 4:n.masterSeed=new Uint8Array(t,r,d);break;case 5:n.transformSeed=new Uint8Array(t,r,d);break;case 6:n.keyRounds=l.getUint32(0,e.Util.littleEndian),n.keyRounds2=l.getUint32(4,e.Util.littleEndian);break;case 7:n.iv=new Uint8Array(t,r,d);break;case 8:n.protectedStreamKey=new Uint8Array(t,r,d);break;case 9:n.streamStartBytes=new Uint8Array(t,r,d);break;case 10:n.innerRandomStreamId=l.getUint32(0,e.Util.littleEndian)}r+=d}n.kdbx=!0,n.dataStart=r}catch(c){throw new Error("Failed to parse KDBX file header - file is corrupt or format not supported")}},t}();e.HeaderParser=t}(Keepass||(Keepass={}));var Keepass;!function(e){var t=function(){function t(){}return t.prototype.parse=function(t,r,n){for(var a=[232,48,9,75,151,32,93,42],i=new Salsa20(new Uint8Array(r),a),s=0,o=0,d=new DataView(t),l=[],c=0;c<n.numberOfGroups;c++){for(var u=0,p=0,y={},w=100;65535!=u&&w>0;)u=d.getUint16(o,e.Util.littleEndian),p=d.getUint32(o+2,e.Util.littleEndian),o+=6,this.readGroupField(u,p,t,o,y),o+=p,w-=1;l.push(y)}for(var f=[],c=0;c<n.numberOfEntries;c++){for(var u=0,p=0,U={keys:[]},w=100;65535!=u&&w>0;)u=d.getUint16(o,e.Util.littleEndian),p=d.getUint32(o+2,e.Util.littleEndian),o+=6,this.readEntryField(u,p,t,o,U),o+=p,w-=1;if(U.group=l.filter(function(e){return e.id==U.groupId})[0],U.groupName=U.group.name,U.password){var g=new TextEncoder,h=g.encode(U.password),m=i.encrypt(new Uint8Array(h));U.protectedData={password:{data:m,position:s}},U.password=btoa(m),s+=h.byteLength}"Meta-Info"==U.title&&"SYSTEM"==U.userName||"Backup"==U.groupName||"Search Results"==U.groupName||f.push(U)}return f},t.prototype.readEntryField=function(t,r,n,a,i){var s=new DataView(n,a,r),o=new Uint8Array(0);r>0&&(o=new Uint8Array(n,a,r-1));var d=new TextDecoder;switch(t){case 0:break;case 1:i.id=e.Util.convertArrayToUUID(new Uint8Array(n,a,r));break;case 2:i.groupId=s.getUint32(0,e.Util.littleEndian);break;case 3:i.iconId=s.getUint32(0,e.Util.littleEndian);break;case 4:i.title=d.decode(o),i.keys.push("title");break;case 5:i.url=d.decode(o),i.keys.push("url");break;case 6:i.userName=d.decode(o),i.keys.push("userName");break;case 7:i.password=d.decode(o);break;case 8:i.notes=d.decode(o),i.keys.push("notes")}},t.prototype.readGroupField=function(t,r,n,a,i){var s=new DataView(n,a,r),o=new Uint8Array(0);switch(r>0&&(o=new Uint8Array(n,a,r-1)),t){case 0:break;case 1:i.id=s.getUint32(0,e.Util.littleEndian);break;case 2:var d=new TextDecoder;i.name=d.decode(o)}},t}();e.KdbParser=t}(Keepass||(Keepass={}));var Keepass;!function(e){var t=function(){function t(){this.headerParser=new e.HeaderParser}return t.prototype.getKey=function(e,t,r){var n=[],a={name:"SHA-256"};if(t||!r){var i=new TextEncoder,s=i.encode(t),o=window.crypto.subtle.digest(a,new Uint8Array(s));n.push(o)}return r&&n.push(Promise.resolve(r)),Promise.all(n).then(function(t){if(e.kdbx||n.length>1){for(var r=new Uint8Array(32*t.length),i=0;i<t.length;i++)r.set(new Uint8Array(t[i]),32*i);return window.crypto.subtle.digest(a,r)}return n[0]})},t.prototype.getPasswords=function(t,r,n){var a=this,i=n?atob(n):null,s=this.headerParser.readHeader(t);if(!s)throw new Error("Failed to read file header");if(2!=s.innerRandomStreamId&&0!=s.innerRandomStreamId)throw new Error("Invalid Stream Key - Salsa20 is supported by this implementation, Arc4 and others not implemented.");var o=new Uint8Array(t,s.dataStart),d={name:"SHA-256"},l={name:"AES-CBC",iv:s.iv},c=this.getKey(s,r,i);return c.then(function(e){return a.aes_ecb_encrypt(s.transformSeed,e,s.keyRounds)}).then(function(e){return window.crypto.subtle.digest({name:"SHA-256"},e)}).then(function(e){var t=new Uint8Array(s.masterSeed.byteLength+32);return t.set(s.masterSeed),t.set(new Uint8Array(e),s.masterSeed.byteLength),window.crypto.subtle.digest(d,t)}).then(function(e){return window.crypto.subtle.importKey("raw",e,l,!1,["decrypt"])}).then(function(e){return window.crypto.subtle.decrypt(l,e,o)}).then(function(t){if(s.kdbx){for(var r=new Uint8Array(t,0,32),n=0;32>n;n++)if(r[n]!=s.streamStartBytes[n])throw new Error("Decryption succeeded but payload corrupt");for(var i=!1,o=32,d=[],l=0;!i;){{var c=new DataView(t,o,40),u=(c.getUint32(0,e.Util.littleEndian),c.getUint32(36,e.Util.littleEndian));new Uint8Array(t,o+4,32)}if(u>0){var p=new Uint8Array(t,o+40,u);d.push(p),l+=u,o+=u+40}else i=!0}var y=new Uint8Array(l);o=0;for(var n=0;n<d.length;n++)y.set(d[n],o),o+=d[n].byteLength;1==s.compressionFlags&&(y=pako.inflate(y));var w=new TextDecoder,f=w.decode(y);return a.decryptStreamKey(s.protectedStreamKey).then(function(e){var t=a.parseXml(f);return t})}return a.decryptStreamKey(s.protectedStreamKey).then(function(r){var n=(new e.KdbParser).parse(t,r,s);return n})})},t.prototype.decryptStreamKey=function(e){var t=this;return window.crypto.subtle.digest({name:"SHA-256"},e).then(function(e){return t.streamKey=e,e})},t.prototype.decryptProtectedData=function(e,t){if(void 0===e)return"";var r=[232,48,9,75,151,32,93,42],n=new Salsa20(new Uint8Array(t||this.streamKey),r),a=new TextDecoder;n.getBytes(e.position);var i=new Uint8Array(n.decrypt(e.data));return a.decode(i)},t.prototype.parseXml=function(t){for(var r=(new TextDecoder,new DOMParser),n=r.parseFromString(t,"text/xml"),a=[],i=n.evaluate("//Entry",n,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),s=0,o=0;o<i.snapshotLength;o++){var d=i.snapshotItem(o),l={protectedData:{},keys:[]};if("History"!=d.parentNode.nodeName){for(var c=0;c<d.parentNode.children.length;c++){var u=d.parentNode.children[c];"Name"==u.nodeName&&(l.groupName=u.textContent)}"Recycle Bin"!=l.groupName&&a.push(l)}for(var p=0;p<d.children.length;p++){var y=d.children[p];if("UUID"==y.nodeName)l.id=e.Util.convertArrayToUUID(e.Util.str2ab(atob(y.textContent)));else if("IconID"==y.nodeName)l.iconId=Number(y.textContent);else if("Tags"==y.nodeName&&y.textContent)l.tags=y.textContent,l.keys.push("tags");else if("Binary"==y.nodeName)l.binaryFiles=y.textContent,l.keys.push("binaryFiles");else if("String"==y.nodeName){var w=y.getElementsByTagName("Key")[0].textContent;w=Case.camel(w);var f=y.getElementsByTagName("Value")[0],U=f.textContent,g=f.hasAttribute("Protected");if(g){var h=new Uint8Array(e.Util.str2ab(atob(U)));l.protectedData[w]={position:s,data:h},s+=h.length}else l.keys.push(w);l[w]=U}}}return a},t.prototype.aes_ecb_encrypt=function(e,t,r){var n=this;t=new Uint8Array(t);for(var a=t.byteLength/16,i=new Array(a),s=0;a>s;s++){var o=t.subarray(16*s,16*s+16);i[s]=function(t){return n.aes_cbc_rounds(t,e,r)}(o)}return Promise.all(i).then(function(e){for(var r=new Uint8Array(t.byteLength),n=0;a>n;n++)r.set(e[n],16*n);return r})},t.prototype.aes_cbc_rounds=function(e,t,r){var n=this;return 0==r?e:r>65535?this.aes_cbc_rounds_single(e,t,65535).then(function(e){return n.aes_cbc_rounds(e,t,r-65535)}):this.aes_cbc_rounds_single(e,t,r)},t.prototype.aes_cbc_rounds_single=function(e,t,r){var n={name:"AES-CBC",iv:e};return window.crypto.subtle.importKey("raw",t,n,!1,["encrypt"]).then(function(e){var t=new Uint8Array(16*r);return window.crypto.subtle.encrypt(n,e,t)}).then(function(e){return new Uint8Array(e,16*(r-1),16)})},t}();e.Database=t}(Keepass||(Keepass={}));var Keepass;!function(e){var t=function(){function e(){}return e.convertArrayToUUID=function(e){for(var t=new Uint8Array(e),r=new Array(2*t.byteLength),n=0;n<t.byteLength;n++)r[2*n]=t[n].toString(16).toUpperCase();return r.join("")},e.str2ab=function(e){for(var t=e.length,r=new Uint8Array(t),n=0;t>n;n++)r[n]=e.charCodeAt(n);return r.buffer},e.littleEndian=function(){var e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}(),e}();e.Util=t}(Keepass||(Keepass={}));