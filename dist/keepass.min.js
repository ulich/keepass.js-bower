var Keepass;!function(e){var t=function(){function t(){this.AES_CIPHER_UUID=new Uint8Array([49,193,242,230,191,113,67,80,190,88,5,33,106,252,90,255])}return t.prototype.readHeader=function(t){var r=new DataView(t,0,8),n={sigKeePass:r.getUint32(0,e.Util.littleEndian),sigKeePassType:r.getUint32(4,e.Util.littleEndian)},a=2594363651,i=3041655655,s=3041655654,o=3041655637,d=3041655653;if(n.sigKeePass!=a||n.sigKeePassType!=i&&n.sigKeePassType!=s&&n.sigKeePassType!=o&&n.sigKeePassType!=d)throw console.log("Signature fail.  sig 1:"+n.sigKeePass.toString(16)+", sig2:"+n.sigKeePassType.toString(16)),new Error("This is not a valid KeePass file - file signature is not correct.");return n.sigKeePassType==i||n.sigKeePassType==s?this.readKdbxHeader(t,8,n):this.readKdbHeader(t,8,n),n},t.prototype.readKdbHeader=function(t,r,n){var a=2,i=new DataView(t,r,116),s=i.getUint32(0,e.Util.littleEndian);if((s&a)!=a)throw new Error("We only support AES (aka Rijndael) encryption on KeePass KDB files.  This file is using something else.");try{n.cipher=this.AES_CIPHER_UUID,n.majorVersion=i.getUint16(4,e.Util.littleEndian),n.minorVersion=i.getUint16(6,e.Util.littleEndian),n.masterSeed=new Uint8Array(t,r+8,16),n.iv=new Uint8Array(t,r+24,16),n.numberOfGroups=i.getUint32(40,e.Util.littleEndian),n.numberOfEntries=i.getUint32(44,e.Util.littleEndian),n.contentsHash=new Uint8Array(t,r+48,32),n.transformSeed=new Uint8Array(t,r+80,32),n.keyRounds=i.getUint32(112,e.Util.littleEndian),n.keyRounds2=0,n.compressionFlags=0,n.protectedStreamKey=window.crypto.getRandomValues(new Uint8Array(16)),n.innerRandomStreamId=0,n.streamStartBytes=null,n.kdb=!0,n.dataStart=r+116}catch(o){throw new Error("Failed to parse KDB file header - file is corrupt or format not supported")}},t.prototype.readKdbxHeader=function(t,r,n){try{var a=new DataView(t,r,4);n.majorVersion=a.getUint16(0,e.Util.littleEndian),n.minorVersion=a.getUint16(2,e.Util.littleEndian),r+=4;for(var i=!1;!i;){var s=new DataView(t,r,3),o=s.getUint8(0),d=s.getUint16(1,e.Util.littleEndian),l=new DataView(t,r+3,d);switch(r+=3,o){case 0:i=!0;break;case 2:n.cipher=new Uint8Array(t,r,d);break;case 3:n.compressionFlags=l.getUint32(0,e.Util.littleEndian);break;case 4:n.masterSeed=new Uint8Array(t,r,d);break;case 5:n.transformSeed=new Uint8Array(t,r,d);break;case 6:n.keyRounds=l.getUint32(0,e.Util.littleEndian),n.keyRounds2=l.getUint32(4,e.Util.littleEndian);break;case 7:n.iv=new Uint8Array(t,r,d);break;case 8:n.protectedStreamKey=new Uint8Array(t,r,d);break;case 9:n.streamStartBytes=new Uint8Array(t,r,d);break;case 10:n.innerRandomStreamId=l.getUint32(0,e.Util.littleEndian)}r+=d}n.kdbx=!0,n.dataStart=r}catch(u){throw new Error("Failed to parse KDBX file header - file is corrupt or format not supported")}},t}();e.HeaderParser=t}(Keepass||(Keepass={}));var Keepass;!function(e){var t=function(){function t(){}return t.prototype.parse=function(t,r,n){for(var a=[232,48,9,75,151,32,93,42],i=new Salsa20(new Uint8Array(r),a),s=0,o=0,d=new DataView(t),l=[],u=0;u<n.numberOfGroups;u++){for(var c=0,y=0,p={},f=100;65535!=c&&f>0;)c=d.getUint16(o,e.Util.littleEndian),y=d.getUint32(o+2,e.Util.littleEndian),o+=6,this.readGroupField(c,y,t,o,p),o+=y,f-=1;l.push(p)}for(var w=[],u=0;u<n.numberOfEntries;u++){for(var c=0,y=0,h={keys:[]},f=100;65535!=c&&f>0;)c=d.getUint16(o,e.Util.littleEndian),y=d.getUint32(o+2,e.Util.littleEndian),o+=6,this.readEntryField(c,y,t,o,h),o+=y,f-=1;if(h.group=l.filter(function(e){return e.id==h.groupId})[0],h.groupName=h.group.name,h.password){var U=new TextEncoder,g=U.encode(h.password),m=i.encrypt(new Uint8Array(g));h.protectedData={password:{data:m,position:s}},h.password=btoa(m),s+=g.byteLength}"Meta-Info"==h.title&&"SYSTEM"==h.userName||"Backup"==h.groupName||"Search Results"==h.groupName||w.push(h)}return w},t.prototype.readEntryField=function(t,r,n,a,i){var s=new DataView(n,a,r),o=new Uint8Array(0);r>0&&(o=new Uint8Array(n,a,r-1));var d=new TextDecoder;switch(t){case 0:break;case 1:i.id=e.Util.convertArrayToUUID(new Uint8Array(n,a,r));break;case 2:i.groupId=s.getUint32(0,e.Util.littleEndian);break;case 3:i.iconId=s.getUint32(0,e.Util.littleEndian);break;case 4:i.title=d.decode(o),i.keys.push("title");break;case 5:i.url=d.decode(o),i.keys.push("url");break;case 6:i.userName=d.decode(o),i.keys.push("userName");break;case 7:i.password=d.decode(o);break;case 8:i.notes=d.decode(o),i.keys.push("notes")}},t.prototype.readGroupField=function(t,r,n,a,i){var s=new DataView(n,a,r),o=new Uint8Array(0);switch(r>0&&(o=new Uint8Array(n,a,r-1)),t){case 0:break;case 1:i.id=s.getUint32(0,e.Util.littleEndian);break;case 2:var d=new TextDecoder;i.name=d.decode(o)}},t}();e.KdbParser=t}(Keepass||(Keepass={}));var Keepass;!function(e){var t=function(){function t(){this.headerParser=new e.HeaderParser,this.masterKeyUtil=new e.MasterKeyUtil}return t.prototype.getPasswords=function(t,r,n){var a=this,i=this.headerParser.readHeader(t);if(!i)throw new Error("Failed to read file header");if(2!=i.innerRandomStreamId&&0!=i.innerRandomStreamId)throw new Error("Invalid Stream Key - Salsa20 is supported by this implementation, Arc4 and others not implemented.");var s=new Uint8Array(t,i.dataStart),o={name:"SHA-256"},d={name:"AES-CBC",iv:i.iv};return this.masterKeyUtil.inferMasterKey(i,r,n).then(function(e){return a.aes_ecb_encrypt(i.transformSeed,e,i.keyRounds)}).then(function(e){return window.crypto.subtle.digest({name:"SHA-256"},e)}).then(function(e){var t=new Uint8Array(i.masterSeed.byteLength+32);return t.set(i.masterSeed),t.set(new Uint8Array(e),i.masterSeed.byteLength),window.crypto.subtle.digest(o,t)}).then(function(e){return window.crypto.subtle.importKey("raw",e,d,!1,["decrypt"])}).then(function(e){return window.crypto.subtle.decrypt(d,e,s)}).then(function(t){if(i.kdbx){for(var r=new Uint8Array(t,0,32),n=0;32>n;n++)if(r[n]!=i.streamStartBytes[n])throw new Error("Decryption succeeded but payload corrupt");for(var s=!1,o=32,d=[],l=0;!s;){{var u=new DataView(t,o,40),c=(u.getUint32(0,e.Util.littleEndian),u.getUint32(36,e.Util.littleEndian));new Uint8Array(t,o+4,32)}if(c>0){var y=new Uint8Array(t,o+40,c);d.push(y),l+=c,o+=c+40}else s=!0}var p=new Uint8Array(l);o=0;for(var n=0;n<d.length;n++)p.set(d[n],o),o+=d[n].byteLength;1==i.compressionFlags&&(p=pako.inflate(p));var f=new TextDecoder,w=f.decode(p);return a.decryptStreamKey(i.protectedStreamKey).then(function(e){var t=a.parseXml(w);return t})}return a.decryptStreamKey(i.protectedStreamKey).then(function(r){var n=(new e.KdbParser).parse(t,r,i);return n})})},t.prototype.decryptStreamKey=function(e){var t=this;return window.crypto.subtle.digest({name:"SHA-256"},e).then(function(e){return t.streamKey=e,e})},t.prototype.decryptProtectedData=function(e,t){if(void 0===e)return"";var r=[232,48,9,75,151,32,93,42],n=new Salsa20(new Uint8Array(t||this.streamKey),r),a=new TextDecoder;n.getBytes(e.position);var i=new Uint8Array(n.decrypt(e.data));return a.decode(i)},t.prototype.parseXml=function(t){for(var r=(new TextDecoder,new DOMParser),n=r.parseFromString(t,"text/xml"),a=[],i=n.evaluate("//Entry",n,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),s=0,o=0;o<i.snapshotLength;o++){var d=i.snapshotItem(o),l={protectedData:{},keys:[]};if("History"!=d.parentNode.nodeName){for(var u=0;u<d.parentNode.children.length;u++){var c=d.parentNode.children[u];"Name"==c.nodeName&&(l.groupName=c.textContent)}"Recycle Bin"!=l.groupName&&a.push(l)}for(var y=0;y<d.children.length;y++){var p=d.children[y];if("UUID"==p.nodeName)l.id=e.Util.convertArrayToUUID(e.Util.str2ab(atob(p.textContent)));else if("IconID"==p.nodeName)l.iconId=Number(p.textContent);else if("Tags"==p.nodeName&&p.textContent)l.tags=p.textContent,l.keys.push("tags");else if("Binary"==p.nodeName)l.binaryFiles=p.textContent,l.keys.push("binaryFiles");else if("String"==p.nodeName){var f=p.getElementsByTagName("Key")[0].textContent;f=Case.camel(f);var w=p.getElementsByTagName("Value")[0],h=w.textContent,U=w.hasAttribute("Protected");if(U){var g=new Uint8Array(e.Util.str2ab(atob(h)));l.protectedData[f]={position:s,data:g},s+=g.length}else l.keys.push(f);l[f]=h}}}return a},t.prototype.aes_ecb_encrypt=function(e,t,r){var n=this;t=new Uint8Array(t);for(var a=t.byteLength/16,i=new Array(a),s=0;a>s;s++){var o=t.subarray(16*s,16*s+16);i[s]=function(t){return n.aes_cbc_rounds(t,e,r)}(o)}return Promise.all(i).then(function(e){for(var r=new Uint8Array(t.byteLength),n=0;a>n;n++)r.set(e[n],16*n);return r})},t.prototype.aes_cbc_rounds=function(e,t,r){var n=this;return 0==r?e:r>65535?this.aes_cbc_rounds_single(e,t,65535).then(function(e){return n.aes_cbc_rounds(e,t,r-65535)}):this.aes_cbc_rounds_single(e,t,r)},t.prototype.aes_cbc_rounds_single=function(e,t,r){var n={name:"AES-CBC",iv:e};return window.crypto.subtle.importKey("raw",t,n,!1,["encrypt"]).then(function(e){var t=new Uint8Array(16*r);return window.crypto.subtle.encrypt(n,e,t)}).then(function(e){return new Uint8Array(e,16*(r-1),16)})},t}();e.Database=t}(Keepass||(Keepass={}));var Keepass;!function(e){var t=function(){function t(){}return t.prototype.getKeyFromFile=function(t){if(0==t.byteLength)return Promise.reject(new Error("key file has zero bytes"));if(32==t.byteLength)return Promise.resolve(t);if(64==t.byteLength){var r=new TextDecoder,n=r.decode(t),a=e.Util.hex2arr(n);if(32==a.length)return Promise.resolve(a)}try{var r=new TextDecoder,i=r.decode(t),s=new DOMParser,o=s.parseFromString(i,"text/xml"),d=o.evaluate("//KeyFile/Key/Data",o,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null);if(d.singleNodeValue&&d.singleNodeValue.textContent)return Promise.resolve(e.Util.str2ab(atob(d.singleNodeValue.textContent)))}catch(l){}return window.crypto.subtle.digest({name:"SHA-256"},t)},t}();e.KeyFileParser=t}(Keepass||(Keepass={}));var Keepass;!function(e){var t=function(){function t(){this.keyFileParser=new e.KeyFileParser}return t.prototype.inferMasterKey=function(e,t,r){var n=this;return r?this.keyFileParser.getKeyFromFile(r).then(function(r){return n.infer(e,t,r)}):this.infer(e,t)},t.prototype.infer=function(e,t,r){var n=[],a={name:"SHA-256"};if(t||!r){var i=new TextEncoder,s=i.encode(t),o=window.crypto.subtle.digest(a,new Uint8Array(s));n.push(o)}return r&&n.push(Promise.resolve(r)),Promise.all(n).then(function(t){if(e.kdbx||n.length>1){for(var r=new Uint8Array(32*t.length),i=0;i<t.length;i++)r.set(new Uint8Array(t[i]),32*i);return window.crypto.subtle.digest(a,r)}return n[0]})},t}();e.MasterKeyUtil=t}(Keepass||(Keepass={}));var Keepass;!function(e){var t=function(){function e(){}return e.convertArrayToUUID=function(e){for(var t=new Uint8Array(e),r=new Array(2*t.byteLength),n=0;n<t.byteLength;n++)r[2*n]=t[n].toString(16).toUpperCase();return r.join("")},e.ab2str=function(e){for(var t="",r=new Uint8Array(e),n=0;n<r.byteLength;n++)t+=String.fromCharCode(r[n]);return t},e.str2ab=function(e){for(var t=e.length,r=new Uint8Array(t),n=0;t>n;n++)r[n]=e.charCodeAt(n);return r.buffer},e.hex2arr=function(e){if(e.length%2!=0||!/^[0-9A-Fa-f]+$/.test(e))return[];for(var t=[],r=0;r<e.length;r+=2)t.push(parseInt(e.substr(r,2),16));return t},e.littleEndian=function(){var e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}(),e}();e.Util=t}(Keepass||(Keepass={}));